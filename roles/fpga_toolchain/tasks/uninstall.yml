---

## Note: from release 2025.1 onwards, the installation layout changed.
#   Up to 2024.2, the directory for a specific release was inside the directory for the
#   program (eg. <install_path>/Vivado/2024.2)
#
#   From 2025.1 onwards, all program directories are in a release directory
#   (eg. <install_path>/2025.1/Vivado)
##

- name: Remove unwanted releases
  when: (release.split('.')[0] | int >= 2025)
  ansible.builtin.command:
    cmd: "{{ fpga_toolchain_install_path }}/.xinstall/{{ release }}/xsetup -b Uninstall"
  changed_when: true

- name: Remove unwanted releases
  when: (release.split('.')[0] | int <= 2024)
  block:
    - name: Gather installations
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - "{{ fpga_toolchain_install_path }}/.xinstall/Vivado_{{ release }}"
        - "{{ fpga_toolchain_install_path }}/.xinstall/Vitis_{{ release }}"
      register: xinstall_stats

    - name: Remove Vivado installation
      ansible.builtin.command:
        cmd: "{{ fpga_toolchain_install_path }}/.xinstall/Vivado_{{ release }}/xsetup -b Uninstall"
      changed_when: true
      when: xinstall_stats.results[0].stat.exists

    - name: Remove Vitis installation
      ansible.builtin.command:
        cmd: "{{ fpga_toolchain_install_path }}/.xinstall/Vitis_{{ release }}/xsetup -b Uninstall"
      changed_when: true
      when: xinstall_stats.results[1].stat.exists

- name: Remove module loading
  ansible.builtin.lineinfile:
    path: /etc/profile.d/vivado.sh
    regexp: "module load vivado/{{ release }}"
    state: absent

- name: Remove module file for this release
  ansible.builtin.file:
    path: "/usr/share/modules/modulefiles/vivado/{{ release }}"
    state: absent

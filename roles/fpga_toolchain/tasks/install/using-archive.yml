---

##
# Parameters:
#   - `amd_fpga_toolchain_release`:        Object containing install info: release, vivado_only, update_level (required)

# FACTS GATHERING

- name: "[Install {{ amd_fpga_toolchain_release.release }}] Load release options"
  ansible.builtin.set_fact:
    release: "{{ amd_fpga_toolchain_release.release }}"
    vivado_only: "{{ amd_fpga_toolchain_release.vivado_only }}"
    update_level: "{{ amd_fpga_toolchain_release.update_level }}"

- name: "[Install {{ release }}] Set AMD Toolchain facts"
  ansible.builtin.set_fact:
    amd_fpga_toolchain_package: >-
      {{ amd_fpga_toolchain_packages[release]['archive'][update_level]['package'] }}
    amd_fpga_toolchain_archive_extention: >-
      {{ amd_fpga_toolchain_packages[release]['archive'][update_level]['extention'] }}
    amd_fpga_toolchain_archive_checksum: >-
      {{ amd_fpga_toolchain_packages[release]['archive'][update_level]['checksum_md5'] }}
    amd_fpga_toolchain_prerequisites: >-
      {{ amd_fpga_toolchain_packages[release]['prerequisites'] }}

- name: "[Install {{ release }}] Set archive name fact"
  ansible.builtin.set_fact:
    amd_fpga_toolchain_archive: >-
      {{ amd_fpga_toolchain_package }}{{ amd_fpga_toolchain_archive_extention }}

- name: "[Install {{ release }}] Set tools archive extraction path"
  ansible.builtin.set_fact:
    amd_fpga_toolchain_extraction_path: >-
      {{ amd_fpga_toolchain_download_path }}/{{ release }}
    amd_fpga_toolchain_archive_path: >-
      {{ amd_fpga_toolchain_download_path }}/{{ release }}/{{ amd_fpga_toolchain_archive }}


# CHECK ARCHIVE

- name: "[Install {{ release }}] Check if the tools archive needs to be extracted"
  stat:
    path: "{{ amd_fpga_toolchain_extraction_path }}/{{ amd_fpga_toolchain_package }}"
  register: amd_fpga_toolchain_extraction_stats

- debug:
    msg: >-
      [INFO] Archive precense assertions will be skipped, because the tools have already
      been extracted. Allowing users to remove the archive if desired.
  when: amd_fpga_toolchain_extraction_stats.stat.exists

- name: "[Install {{ release }}] Extraction directory does not yet exist"
  when: not amd_fpga_toolchain_extraction_stats.stat.exists
  block:
    - name: "[Install {{ release }}] Check if the tools archive has already been downloaded"
      stat:
        path: "{{ amd_fpga_toolchain_archive_path }}"
        checksum_algorithm: md5
        get_checksum: true
      register: amd_fpga_toolchain_archive_stats

    - name: "[Install {{ release }}] Assert that the archive is available"
      assert:
        that:
          - amd_fpga_toolchain_archive_stats.stat.exists
        fail_msg: >-
          [ERROR] Can't find the AMD tools archive: {{ amd_fpga_toolchain_archive_path }}.
          Please download it from
          https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/vitis.html

    - name: "[Install {{ release }}] Assert that the checksum of the archive is correct"
      assert:
        that:
          - amd_fpga_toolchain_archive_stats.stat.checksum == amd_fpga_toolchain_archive_checksum
        fail_msg: "[ERROR] Checksum of archive file does not correspond to expected md5 checksum: {{ amd_fpga_toolchain_archive_path }}. The file might have been tampered with. Please download the correct version from https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/vitis.html"


# EXTRACTION

- debug:
    msg: "[INFO] Extraction will be skipped, because the tools have already been extracted. If you want to redo the extraction, make sure that the archive `{{ amd_fpga_toolchain_archive_path }}` exists, and the extracted archive at location `{{ amd_fpga_toolchain_extraction_path }}/{{ amd_fpga_toolchain_package }}` is deleted."
  when: amd_fpga_toolchain_extraction_stats.stat.exists

- when:
    - not amd_fpga_toolchain_extraction_stats.stat.exists
  block:
    - name: "[Install {{ release }}] Ensure Vitis archive extraction directory exists"
      ansible.builtin.file:
        path: "{{ amd_fpga_toolchain_extraction_path }}/{{ amd_fpga_toolchain_package }}"
        state: directory

    - name: "[Install {{ release }}] Extract Vitis core archive (100+ GB file, may take a while...)"
      unarchive:
        src: "{{ amd_fpga_toolchain_archive_path }}"
        dest: "{{ amd_fpga_toolchain_extraction_path }}"
        remote_src: true
        extra_opts: "--no-same-owner"


# INSTALL

- name: "[Install {{ release }}] Install prerequisite packages"
  package:
    name: "{{ amd_fpga_toolchain_prerequisites }}"
    state: present

- name: "[Install {{ release }}] Ensure Vitis install directory exists"
  ansible.builtin.file:
    path: "{{ amd_fpga_toolchain_install_path }}"
    state: directory

- name: "[Install {{ release }}] Ensure config directory exists for the {{ release }} release"
  ansible.builtin.file:
    path: "/root/.Xilinx/{{ release }}"
    state: directory

- name: "[Install {{ release }}] Generate AMD tools configuration file"
  expect:
    command: >-
      ./xsetup --batch ConfigGen
      --location {{ amd_fpga_toolchain_install_path }}
      --product '{% if vivado_only %}Vivado{% else %}Vitis{% endif %}'
    responses:
      "Please choose: ":
        - "1"
  args:
    chdir: "{{ amd_fpga_toolchain_extraction_path }}/{{ amd_fpga_toolchain_package }}"

- name: "[Install {{ release }}] Copy install_config to release directory"
  copy:
    src: /root/.Xilinx/install_config.txt
    dest: "/root/.Xilinx/{{ release }}/install_config.txt"
    remote_src: true

- name: "[Install {{ release }}] Edit install config"
  include_tasks: edit-install-config.yml
  vars:
    config_path: "/root/.Xilinx/{{ release }}/install_config.txt"

- name: "[Install {{ release }}] Install tools (this usually takes about 2 hours, but can take up to 6 hours...)"
  command: >-
    ./xsetup --batch Install
    --config /root/.Xilinx/{{ release }}/install_config.txt
    --agree XilinxEULA,3rdPartyEULA
  args:
    chdir: "{{ amd_fpga_toolchain_extraction_path }}/{{ amd_fpga_toolchain_package }}"
  vars:
    # wait up to 6 hours
    ansible_command_timout: 21600
    ansible_ssh_timout: 21600

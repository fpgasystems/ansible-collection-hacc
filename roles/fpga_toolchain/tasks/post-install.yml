---

- name: Set bash environment
  when:
    - installed_releases | length | int == 1
    - amd_fpga_toolchain_set_bash_environment_variables
  block:
    - name: Load release options
      ansible.builtin.set_fact:
        release: "{{ (installed_releases | first )['release'] }}"
        vivado_only: "{{ (installed_releases | first )['vivado_only'] }}"

    - name: Delete all bash 'source' entries that are not for this release
      ansible.builtin.lineinfile:
        path: /etc/bash.bashrc
        regexp: >-
          ^source {{ amd_fpga_toolchain_install_path
          }}/(?!{{ release }}/)[^/]+/(?!{{ release }}/)[^/]+/settings64.sh$
        state: absent

    - name: Delete all bash 'export' entries that are not for this release
      ansible.builtin.lineinfile:
        path: /etc/bash.bashrc
        regexp: >-
          ^export PATH={{ amd_fpga_toolchain_install_path
          }}/(?!{{ release }}/)[^/]+/(?!{{ release }}/)[^/]+/bin:\$PATH$
        state: absent

    # Vivado is always installed
    # Vitis_HLS also comes with Vivado
    - name: Add Vivado source scripts to general bashrc
      lineinfile:
        path: /etc/bash.bashrc
        insertbefore: '^source\s+/opt/xilinx/xrt/setup.sh'
        line: >-
          source
          {{
            amd_fpga_toolchain_install_path
            | fpga_systems.hacc.tools_path(release, program)
          }}/settings64.sh
        state: present
      loop:
        - "Vivado"
        - "Vitis_HLS"
      loop_control:
        loop_var: program

    # Vitis is only installed, when vivado_only == false
    # Model Composer comes with Vitis
    - name: Add Vitis source scripts to general bashrc
      lineinfile:
        path: /etc/bash.bashrc
        insertbefore: '^source\s+/opt/xilinx/xrt/setup.sh'
        line: >-
          source
          {{
            amd_fpga_toolchain_install_path
            | fpga_systems.hacc.tools_path(release, program)
          }}/settings64.sh
        state: >-
          {{
            'absent' if (vivado_only|bool) else 'present'
          }}
      loop:
        - "Vitis"
        - "Model_Composer"
      loop_control:
        loop_var: program

    - name: Add Vitis Model Composer to system-wide PATH
      lineinfile:
        path: /etc/bash.bashrc
        line: >-
          export PATH={{
            amd_fpga_toolchain_install_path
            | fpga_systems.hacc.tools_path(release, "Model_Composer")
          }}/bin:$PATH
        state: >-
          {{
            'absent' if (vivado_only|bool) else 'present'
          }}

- name: "INFO: `set_bash_environment_variables: true` is ignored"
  debug:
    msg: >-
      amd_fpga_toolchain_set_bash_environment_variables is set to true,
      but this is ignored as there are more than one releases defined in
      the amd_fpga_toolchain_releases variable. Only one version can be actived
      at a time. Use a tool like `hdev` or `module` to manage multiple versions.
  when:
    - installed_releases | length > 1
    - amd_fpga_toolchain_set_bash_environment_variables

- name: Delete all bash entries
  when: >-
    not amd_fpga_toolchain_set_bash_environment_variables or
    (installed_releases | length > 1)
  ansible.builtin.lineinfile:
    path: /etc/bash.bashrc
    regexp: >-
      ^source {{ amd_fpga_toolchain_install_path
      }}/[^/]+/[^/]+/settings64.sh$
    state: absent

- name: Delete all bash 'export' entries
  when: >-
    not amd_fpga_toolchain_set_bash_environment_variables or
    (installed_releases | length > 1)
  ansible.builtin.lineinfile:
    path: /etc/bash.bashrc
    regexp: >-
      ^export PATH={{ amd_fpga_toolchain_install_path
      }}/[^/]+/[^/]+/bin:\$PATH$
    state: absent


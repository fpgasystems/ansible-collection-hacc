---

#  TODO: Convert this to a module

- name: Gather directories of currently installed releases
  ansible.builtin.find:
    paths:
      - "{{ vivado_install_path }}"
    file_type: directory
    use_regex: true
    recurse: true
    depth: 2
  register: found_tools_dirs

- name: Determine for which releases Vivado and Vitis are already present
  ansible.builtin.set_fact:
    releases_with_vivado_dir_present: >-
      {{
        found_tools_dirs.files
        | map(attribute='path')
        | select(
            "match",
            vivado_install_path + "/Vivado/\d{4}\.\d|"
            + vivado_install_path + "/\d{4}\.\d/Vivado"
          )
        | map('regex_search', '(\d{4}\.\d)')
        | list
        | unique
      }}
    releases_with_vitis_dir_present: >-
      {{
        found_tools_dirs.files
        | map(attribute='path')
        | select(
            "match",
            vivado_install_path + "/Vitis/\d{4}\.\d|"
            + vivado_install_path + "/\d{4}\.\d/Vitis"
          )
        | map('regex_search', '(\d{4}\.\d)')
        | list
        | unique
      }}

- name: Determine what to do for each release
  ansible.builtin.set_fact:
    releases_to_install: >-
      {{
        vivado_releases_normalized
        | selectattr('state', 'eq', 'present')
        | rejectattr('release', 'in', releases_with_vivado_dir_present)
        | map(attribute='release')
        | list
      }}
    releases_to_uninstall: >-
      {{
        vivado_releases_normalized
        | selectattr('state', 'eq', 'absent')
        | map(attribute='release')
        | list
      }}
    releases_already_correct: >-
      {{
        vivado_releases_normalized
        | selectattr('state', 'eq', 'present')
        | selectattr('release', 'in', releases_with_vivado_dir_present)
        | selectattr('vivado_only', 'eq', True)
        | rejectattr('release', 'in', releases_with_vitis_dir_present)
        | map(attribute='release')
        | list
        + (
          vivado_releases_normalized
          | selectattr('state', 'eq', 'present')
          | selectattr('release', 'in', releases_with_vivado_dir_present)
          | selectattr('vivado_only', 'eq', False)
          | selectattr('release', 'in', releases_with_vitis_dir_present)
          | map(attribute='release')
          | list
        )
      }}
    releases_to_reinstall: >-
      {{
        vivado_releases_normalized
        | selectattr('state', 'eq', 'present')
        | selectattr('release', 'in', releases_with_vivado_dir_present)
        | selectattr('vivado_only', 'eq', False)
        | rejectattr('release', 'in', releases_with_vitis_dir_present)
        | map(attribute='release')
        | list
        + (
          vivado_releases_normalized
          | selectattr('state', 'eq', 'present')
          | selectattr('release', 'in', releases_with_vivado_dir_present)
          | selectattr('vivado_only', 'eq', True)
          | selectattr('release', 'in', releases_with_vitis_dir_present)
          | map(attribute='release')
          | list
        )
      }}

- name: Add reinstall releases to both install and uninstall lists
  ansible.builtin.set_fact:
    releases_to_install: "{{ (releases_to_install + releases_to_reinstall) | list }}"
    releases_to_uninstall: "{{ (releases_to_uninstall + releases_to_reinstall) | list }}"


- name: Mark dangling Vitis/Vivado releases for removal
  when: vivado_uninstall_dangling_releases
  block:
    - name: Gather directories of dangling releases
      ansible.builtin.find:
        paths:
          - "{{ vivado_install_path }}"
          - "{{ vivado_install_path }}/Vivado"
          - "{{ vivado_install_path }}/Vitis"
          - "{{ vivado_install_path }}/Vitis_HLS"
          - "{{ vivado_install_path }}/Model_Composer"
        file_type: directory
        patterns: '^[0-9]{4}\.[0-9]$'
        use_regex: true
        excludes: "{{ vivado_releases_normalized | map(attribute='release') | list }}"
      register: vivado_dangling_releases

    - name: Add dangling releases to releases to uninstall
      ansible.builtin.set_fact:
        releases_to_uninstall: >-
          {{
            releases_to_uninstall +
            (
              vivado_dangling_releases.files
              | map(attribute='path')
              | map('basename')
              | unique
              | list
            )
            | unique
          }}
